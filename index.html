<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.css">

  <style>
    html,
    body {
      background: white !important;
      height: 100%;
      width: 100%;
      /* overflow-y: auto; */
      padding: 2% 0;
    }

    .card-inbox {
      height: 500px !important;
      overflow-y: auto;
      margin-bottom: 20% !important;
    }


    .btn-compose {
      position: absolute;
      right: 8%;
      bottom: 5%;
      z-index: 5;
    }

    .btn-settings {
      position: absolute;
      right: 12%;
      bottom: 5%;
      z-index: 6;
    }

    .container-1,
    .pusher {
      background: white !important;
    }

    .sidebar {
      padding: 10px;
      width: 150px !important;
    }

    .user {
      text-align: justify !important;

    }
  </style>
</head>


<body>
  <!-- the modal -->
  <div class="ui tiny  modal " id="compose_message">
    <div class="header">
      Compose Message
    </div>

    <div class=" scrolling content ">
      <div class="ui fluid form">
        <div class="field">
          <label>From:</label>
          <input type="text" id="username" placeholder="Username">
        </div>
        <div class="field">
          <label>To:</label>
          <input type="text" id="receiver" placeholder="type 'all' or a specific username">
        </div>
        <div class="field">

          <textarea id="myMessage" placeholder="Edit the receiver's name or start typing here..."></textarea>
        </div>
      </div>
    </div>
    <div class="actions">
      <div class="ui positive send  button">
        Send
      </div>
      <div id="clr-msg" class="ui left deny icon red  button ">
        <span>Cancel</span>
      </div>
    </div>
  </div>
  <!-- end of modal -->

  <div class="ui container .container-1">

    <div class="ui left demo vertical sidebar labeled icon menu">
      <p class="item header"> <span class="count"></span> </p>
      <div class="ui list">
        <div class="item online-users">
          <p class="ui ">
            <i class=" green user icon"></i>
            Yol Torres
          </p>
        </div>
      </div>
    </div>
    <br>

    <div class="ui stackable two column grid">
      <div class="column">

        <div class="ui fluid card card-inbox">
          <div class="content">
            <div class="center aligned  header">GROUP CHAT INBOX</div>
            <hr>
            <div class="groupMessage">
              <!-- content here -->

            </div>
          </div>
        </div>
      </div>
      <!-- column2 -->
      <div class="column">
        <div class="ui  fluid card card-inbox">
          <div class="content ">
            <div class=" center aligned  header">PRIVATE MESSAGE INBOX</div>
            <hr>
            <div class="privateMessage">
              <!-- content here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- register Form -->

  <div class="ui tiny  modal " id="register">
    <div class="header">
      Enter Username
    </div>

    <div class=" scrolling content ">
      <div class="card">

        <div class="username Form ui form content">

          <div class="field">
            <input type="text" id="Myusername" placeholder="Enter your username to start">
          </div>
          <br>
          <center>
            <button class="ui reg-btn positive button">
              <i class="icon user"></i>
              Save
            </button>
          </center>
        </div>
      </div>
    </div>
  </div>

  <button class="ui big btn-compose circular orange plus icon button">
    <i class="plus icon"></i>
  </button>
  <button class="circular ui icon green big button btn-settings">
    <i class="icon bell"></i>
  </button>
  <!-- scripts -->
  <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.js"></script>
  <script>
    $(document).ready(function () {
      var isReply = false;
      var socket = io();
      $('.ui.labeled.icon.sidebar').sidebar('setting', 'transition', 'overlay');
      $('.reg-btn').attr('disabled', true)
      var username = "anonymous";
      $('.btn-settings').click(function () {
        $('.ui.labeled.icon.sidebar').sidebar('toggle');

      })

      $("#Myusername").change(function () {
        if ($(this).val() != "") {
          $('.reg-btn').attr('disabled', false)
          username = $(this).val();
        }
      });

      $('.reg-btn').click(function () {
        $("#Myusername").val("");
        $('#register').modal('hide');
        $('.btn-compose').attr('disabled', false)
        $('#username').attr('disabled', true)
        $("#username").val(username);
        socket.emit('set-online', { username: username })
      })

      $('#register').modal('setting', 'closable', false).modal('show');

      $('.btn-compose').click(function () {
        $('#compose_message').modal('show');
      });

      $('.send').click(function () {
        var myMsg = $('#myMessage').val();
        var receiver = $("#receiver").val();
        if (receiver == "") {
          Swal.fire({
            type: 'error',
            title: "Please specify the receiver either 'all' or username of a friend"
          })
          $("#receiver").val('all')
        } else {
          sendMessage({ sender: username, receiver: receiver, message: myMsg })
        }
      });


      socket.on("message", function (msg) {
        if (msg.receiver == 'all') {
          receiveMessage('.groupMessage', msg)
        } else if (msg.receiver == username) {
          receiveMessage('.privateMessage', msg)
        }

      });

      socket.on('online', function (data) {
        countOnline(data)
      })


      function sendMessage(message) {
        socket.emit("message", message);
        Swal.fire({
          type: 'success',
          title: 'Sent Successfully!',
          backdrop: 'rgba(0, 0, 0, 0.85)'
        });
        logSentMessage(message.message)
      }

      function logSentMessage(myMsg) {
        var inbox ;
        if (!isReply ) {
          inbox = '.groupMessage'
        }else{
          inbox = '.privateMessage'

        }
        $('<div>', { class: "ui compact message_s message  my-message" }).append($('<p>').text(myMsg)).appendTo(inbox);
        $('#myMessage').val('');
        $('#receiver').val('');
      }

      function receiveMessage(inbox, message) {
        $('inbox').append($('<div>', {
          class: "message other-message"
        }).text(msg.sender + " :  " + msg.message).css("margin-top", "10px"), $("<br>"));
      }


      function isTyping(message) {

       }
      function stopTyping(message) { }

      function countOnline(data) {
        $('.online-users').empty()
        $('.count').text("Online: " + (data.length - 1))
        data.forEach(element => {
          if (username != element.username) {
            $('<p>', {
              class: "ui user "
            }).append("<i class = 'green user icon'></i>", $("<span>", {
              class: "user-name"
            }).text(element.username)).appendTo($('.online-users'))
            $(document).on('click', '.user', function () {
              isReply = true;
              $("#receiver").val($(this).text());
              $('#compose_message').modal('show');

            })
          }
        });
      }

    });
  </script>
</body>

</html>