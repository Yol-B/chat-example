<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.css">

    <style>
        html,
        body {
            background: white !important;
            height: 100%;
            width: 100%;
        }
        
        .recieve-message {
            float: left;
        }
        
        .my-container {
            margin: 20px 50px !important;
        }
        
        .online-list,
        .activities {
            height: 520px !important;
            overflow-y: auto;
        }
        
        .msg-card,
        .dimmer {
            height: 520px;
        }
        
        .sidebar {
            padding: 10px;
            width: 150px !important;
        }
        
        .user {
            text-align: justify !important;
        }
        
        .segment {
            border: none !important;
            box-shadow: none !important;
            margin: 0 !important;
        }
        
        .btn-compose {
            border-radius: 40px !important;
        }
        
        .messgeLists {
            background: #E3E3E3;
            height: 380px;
            max-height: 380px;
            overflow-y: scroll;
        }
        
        .chatHeader {
            height: 50px;
            color: white!important;
        }
        
        .item-slider {
            padding: 0 10px;
        }
        
        .formss {
            background: #E8E8E8;
        }
        /* SLIDER */
        
        .slick-slider {
            position: relative;
            display: block;
            /* box-sizing: border-box; */
            user-select: none;
            -webkit-touch-callout: none;
            -khtml-user-select: none;
            -ms-touch-action: pan-y;
            touch-action: pan-y;
            -webkit-tap-highlight-color: transparent;
        }
        
        .slick-list {
            position: relative;
            display: block;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        
        .slick-list:focus {
            outline: none;
        }
        
        .slick-list.dragging {
            cursor: pointer;
            cursor: hand;
        }
        
        .slick-slider .slick-track,
        .slick-slider .slick-list {
            -webkit-transform: translate3d(0, 0, 0);
            -moz-transform: translate3d(0, 0, 0);
            -ms-transform: translate3d(0, 0, 0);
            -o-transform: translate3d(0, 0, 0);
            transform: translate3d(0, 0, 0);
        }
        
        .slick-track {
            position: relative;
            top: 0;
            left: 0;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        .slick-track:before,
        .slick-track:after {
            display: table;
            content: '';
        }
        
        .slick-track:after {
            clear: both;
        }
        
        .slick-loading .slick-track {
            visibility: hidden;
        }
        
        .slick-slide {
            display: none;
            float: left;
            height: 100%;
            min-height: 1px;
        }
        
        [dir='rtl'] .slick-slide {
            float: right;
        }
        
        .slick-initialized .slick-slide {
            display: block;
        }
        
        .slick-loading .slick-slide {
            visibility: hidden;
        }
        
        .slick-vertical .slick-slide {
            display: block;
            height: auto;
            border: 1px solid transparent;
        }
        
        .slick-arrow.slick-hidden {
            display: none;
        }
        
        @font-face {
            font-family: 'slick';
            font-weight: normal;
            font-style: normal;
            src: url('http://kenwheeler.github.io/slick/slick/fonts/slick.eot');
            src: url('http://kenwheeler.github.io/slick/slick/fonts/slick.eot?#iefix') format('embedded-opentype'), url('http://kenwheeler.github.io/slick/slick/fonts/slick.woff') format('woff'), url('http://kenwheeler.github.io/slick/slick/fonts/slick.ttf') format('truetype'), url('./fonts/slick.svg#slick') format('svg');
        }
        /* Arrows */
        
        .slick-prev,
        .slick-next {
            font-size: 0;
            line-height: 0;
            position: absolute;
            top: 50%;
            display: block;
            width: 20px;
            height: 20px;
            padding: 0;
            -webkit-transform: translate(0, -50%);
            -ms-transform: translate(0, -50%);
            transform: translate(0, -50%);
            cursor: pointer;
            color: transparent;
            border: none;
            outline: none;
            background: transparent;
        }
        
        .slick-prev:hover,
        .slick-prev:focus,
        .slick-next:hover,
        .slick-next:focus {
            color: transparent;
            outline: none;
            background: transparent;
        }
        
        .slick-prev:hover:before,
        .slick-prev:focus:before,
        .slick-next:hover:before,
        .slick-next:focus:before {
            opacity: 1;
        }
        
        .slick-prev.slick-disabled:before,
        .slick-next.slick-disabled:before {
            opacity: .25;
        }
        
        .slick-prev:before,
        .slick-next:before {
            font-family: 'slick';
            font-size: 20px;
            line-height: 1;
            opacity: .75;
            color: black;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .slick-prev {
            left: -25px;
        }
        
        [dir='rtl'] .slick-prev {
            right: -25px;
            left: auto;
        }
        
        .slick-prev:before {
            content: '←';
        }
        
        [dir='rtl'] .slick-prev:before {
            content: '→';
        }
        
        .slick-next {
            right: -25px;
        }
        
        [dir='rtl'] .slick-next {
            right: auto;
            left: -25px;
        }
        
        .slick-next:before {
            content: '→';
        }
        
        [dir='rtl'] .slick-next:before {
            content: '←';
        }
        /* Dots */
        
        .slick-dotted.slick-slider {
            margin-bottom: 30px;
        }
        
        .slick-dots {
            position: absolute;
            bottom: -25px;
            display: block;
            width: 100%;
            padding: 0;
            margin: 0;
            list-style: none;
            text-align: center;
        }
        
        .slick-dots li {
            position: relative;
            display: inline-block;
            width: 20px;
            height: 20px;
            margin: 0 5px;
            padding: 0;
            cursor: pointer;
        }
        
        .slick-dots li button {
            font-size: 0;
            line-height: 0;
            display: block;
            width: 20px;
            height: 20px;
            padding: 5px;
            cursor: pointer;
            color: transparent;
            border: 0;
            outline: none;
            background: transparent;
        }
        
        .slick-dots li button:hover,
        .slick-dots li button:focus {
            outline: none;
        }
        
        .slick-dots li button:hover:before,
        .slick-dots li button:focus:before {
            opacity: 1;
        }
        
        .slick-dots li button:before {
            font-family: 'slick';
            font-size: 6px;
            line-height: 20px;
            position: absolute;
            top: 0;
            left: 0;
            width: 20px;
            height: 20px;
            content: '•';
            text-align: center;
            opacity: .25;
            color: black;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .slick-dots li.slick-active button:before {
            opacity: .75;
            color: black;
        }
        
        .template {
            display: none;
        }
    </style>
</head>


<body>

    <div class="ui my-container">
        <div class="ui clearing segment">
            <div class="ui blue basic   right floated button btn-compose">
                <i class="edit icon"></i> New Message
            </div>
        </div>
        <div class="ui stackable four column grid">
            <div class="three wide column">
                <div class="ui card online-list">
                    <div class="content">
                        <p class="item center aligned header">Online : <span class="count"></span> </p>
                        <hr>
                        <div class="ui relaxed divided list ">
                            <div class="item online-users">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="three wide column">
                <div class="ui card activities">
                    <div class="content">
                        <p class="item center aligned header"> Activities</p>
                        <hr>
                        <div class="ui list">
                            <div class="item my-activities">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ten wide column ">
                <div class="ui card msg-card fluid ">
                    <div class="ui segment my-container" style="min-height: 300px">
                        <div class="ui active dimmer" id="loader">
                            <div class="ui medium text loader"><br> YOUR MESSGES ARE LOADING . . .</div>
                        </div>
                        <div class="item-slider">


                        </div>
                        <br><br><br>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- register Form -->

    <div class="ui tiny  modal " id="register">
        <div class="header">
            Enter Username
        </div>

        <div class=" scrolling content ">
            <div class="card">

                <div class="username Form ui form content">

                    <div class="field reg-form">
                        <input type="text" id="Myusername" placeholder="Enter your username to start">
                    </div>
                    <br>
                    <center>
                        <button class="ui reg-btn positive button">
              <i class="icon user"></i>
              Save
            </button>
                    </center>
                </div>
            </div>
        </div>
    </div>

    <div class="inbox template">
        <div class="chatApp">
            <div class="ui top  inverted blue chatHeader   segment">
                <button class="circular basic inverted ui icon mini button">
                  <i class="icon users "></i> 
                 </button>
                <span class="ui  header ">Group Chat <br> </span>
            </div>
            <div class="messgeLists" id="groupchat-msg"></div>
            <div class=" ui blue fluid action  blue input form-area ">
                <input type="text" class="ui blue message-gc" message="groupmsg" placeholder="your message here...">
                <div class="ui labeled button sendMe" receiver="receiver_gc">
                    <div class="ui blue button">
                        <i class="send icon"></i> Send
                    </div>

                </div>
            </div>

        </div>
    </div>



    <!-- scripts -->
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>

    <script>
        $(document).ready(function() {
            var socket = io();
            var cloned = $(".inbox").html();
            $('.reg-btn').attr('disabled', true)
            var username = "anonymous";

            $("#Myusername").change(function() {
                if ($(this).val() != "") {
                    username = $(this).val();
                    socket.emit('check-username', username)
                    socket.on('verify-username', function(reply) {
                        if (reply == '1') {
                            $('.reg-btn').attr('disabled', false)
                        } else {
                            $('.reg-form').append($('<div>', {
                                class: "ui name-error pointing red basic label"
                            }).text("This username is taken!"))

                            $("#Myusername").keydown(function() {
                                $('.name-error').hide()
                            })
                        }
                    })
                }
            });


            socket.on('joined', function(user) {
                if (user == username) {
                    addActivity("You", "joined")
                } else {
                    addActivity(user, "joined")
                }
            })

            socket.on('leave', function(user) {
                addActivity(user, "left")
            })

            $('.reg-btn').click(function() {
                $("#Myusername").val("");
                $('#register').modal('hide');
                $('.btn-compose').attr('disabled', false)
                $('#username').attr('disabled', true)
                $("#username").val(username);
                socket.emit('set-online', {
                    username: username
                })
                init();
            })

            $('#register').modal('setting', 'closable', false).modal('show');

            $('input').on("keypress", function() {
                socket.emit('typing', username)
            })

            //Listen on typing
            socket.on('typing', function(username) {
                $('.user-name').each(function() {
                    if ($(this).text() == username) {
                        $(this).append("<span>", {
                            id: "typing"
                        }).text($(this).text() + '(typing)')
                    }
                });
            })


            $(document).on('click', '.sendMe', function(e) {
                var receiver = $(this).attr("receiver").split("_")[1]
                var message = $(this).closest("div.form-area").find("input").val();
                if (receiver == 'gc') {
                    inbox = "#groupchat-msg"
                } else {
                    inbox = "#" + receiver + "-msg"
                }
                sendMessage({
                    sender: username,
                    receiver: receiver,
                    message: message
                }, inbox)
                $(this).closest("div.form-area").find("input").val("")
            });

            function init() {
                $('.item-slider').slick({
                    slidesToShow: 1,
                    dots: true,
                    slidesToScroll: 1,
                    atoplay: false
                });

                setTimeout(function() {
                    $('#loader').removeClass('active');
                }, 800);

            }

            socket.on("message", function(msg) {
                receiveMessage(msg)
            });

            socket.on('online', function(data) {
                countOnline(data)
            })

            function addActivity(user, activity) {
                var color = 'green'
                if (activity == 'left') {
                    color = 'red';
                }
                $('<p>', {
                    class: "ui item"
                }).append("<i class = '" + color + " circle icon'></i>", $("<span>").text(user + " " + activity + " the room")).appendTo($('.my-activities'))
            }

            function sendMessage(message, inbox) {
                socket.emit("message", message);
                Swal.fire({
                    type: 'success',
                    title: 'Sent Successfully!',
                    backdrop: 'rgba(0, 0, 0, 0.85)'
                });
                logSentMessage(message, inbox)
            }

            function logSentMessage(myMsg, inbox) {
                var inbox;
                $(inbox).append($('<div>', {
                    class: "ui large right pointing blue label "
                }).css({
                    padding: '10px',
                    marginTop: '10px',
                    maxWidth: "200px",
                    wordWrap: 'break-word',
                    float: 'right'
                }).text(myMsg.message), '<br clear="all" />');
                $('#myMessage').val('');
                $('#receiver').val('');
            }

            function receiveMessage(message) {
                var inbox = "";
                if (message.receiver == 'all') {
                    inbox += '.groupMessage'
                } else if (message.receiver == username) {
                    inbox += '.privateMessage'
                }

                $(inbox).append($('<div>', {
                    class: "ui large left pointing teal  label "
                }).css({
                    padding: '10px',
                    marginTop: '10px',
                    maxWidth: "200px",
                    wordWrap: 'break-word'
                }).text(message.sender + " :  " + message.message), '<br clear="all" />');

            }

            function countOnline(data) {
                cloned = cloned.replace("template", "")
                $('.online-users').empty()
                $('.item-slider').slick('slickRemove', null, null, true);
                $(".item-slider").slick('slickAdd', cloned)
                $('.count').text((data.length - 1))
                data.forEach(user => {
                    if (username != user) {
                        var chatBox = cloned.replace("Group Chat", user).replace("groupchat-msg", user + "-msg").replace("receiver_gc", "receiver_" + user).replace("template", "").replace("groupmsg", "private_" + user).replace("message-gc", "message-" + user)
                        $(".item-slider").slick('slickAdd', chatBox)
                        $('<p>', {
                            class: "ui user item"
                        }).append("<i class = 'green user icon'></i>", $("<span>", {
                            class: "user-name"
                        }).text(user)).appendTo($('.online-users'))

                    }
                });
            }
        });
    </script>
</body>


</html>