<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Chat App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.css">

</head>

<body>
    <!-- message modal -->
    <div class="ui tiny  modal " id="compose_message">
        <div class="header">
            Compose Message
        </div>

        <div class=" scrolling content ">
            <div class="ui fluid form">
                <div class="field">
                    <label>From:</label>
                    <input type="text" id="username" placeholder="Username">
                </div>
                <div class="field">
                    <label>To:</label>
                    <input type="text" id="receiver" placeholder="type 'group message' or a specific username">
                </div>
                <div class="field">

                    <textarea id="myMessage" placeholder="start typing here..."></textarea>
                </div>
            </div>
        </div>
        <div class="actions">
            <div class="ui positive send  button">
                Send
            </div>
            <div id="clr-msg" class="ui left deny icon red  button ">
                <span>Cancel</span>
            </div>
        </div>
    </div>
    <!-- end of modal -->
    <div class="ui fluid  center aligned container">
        <div class="ui segment">
            <div class="ui two column very relaxed grid">
                <div class="column">

                </div>
                <div class="column">

                </div>
            </div>
            <div class="ui vertical divider">
                or
            </div>
        </div>
    </div>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.js"></script>
    <script>
        $(document).ready(function () {

            var socket = io();


            $('.reg-btn').attr('disabled', true)
            var username = "anonymous";

            $("#Myusername").change(function () {
                if ($(this).val() != "") {
                    $('.reg-btn').attr('disabled', false)
                    username = $(this).val();
                }
            });

            $('.reg-btn').click(function () {
                $("#Myusername").val("");
                $('#register').modal('hide');
                $('.btn-compose').attr('disabled', false)
                $('#username').attr('disabled', true)
                $("#username").val(username);
                socket.emit('set-online', { username: username })
            })

            $('#register').modal('setting', 'closable', false).modal('show');

            $('.btn-compose').click(function () {
                $('#compose_message').modal('show');
            });

            $('.send').click(function () {
                var myMsg = $('#myMessage').val();
                var receiver = $("#receiver").val();
                if (receiver == "") {
                    receiver = "group message";
                }
                sendMessage({ sender: username, receiver: receiver, message: myMsg })
            });

            socket.on("message", function (msg) {
                alert('newMessage')
                if (msg.receiver == 'group message') {
                    receiveGroupMessage(msg)
                } else if (msg.receiver == username) {
                    receivePrivateMessage(msg)
                }

            });

            socket.on('online', function (data) {
                countOnline(data)
            })

            function sendMessage(message) {
                socket.emit("message", message);
                Swal.fire({
                    type: 'success',
                    title: 'Sent Successfully!',
                    backdrop: 'rgba(0, 0, 0, 0.85)'
                });
                logSentMessage(message.message)
            }

            function logSentMessage(myMsg) {
                $('<div>', { class: "ui compact message_s message  my-message" }).append($('<p>').text(myMsg)).appendTo('.messages');
                $('#myMessage').val('');
                $('#receiver').val('');
            }

            function receivePrivateMessage(message) {
                $('.messages').append($('<div>', {
                    class: "message other-message"
                }).text(msg.sender + " :  " + msg.message).css("margin-top", "10px"), $("<br>"));
            }

            function receiveGroupMessage() {
                $('.messages').append($('<div>', {
                    class: "message other-message"
                }).text(message.sender + message.message).css("margin-top", "10px"), $("<br>"));
            }

            function isTyping(message) { }
            function stopTyping(message) { }

            function countOnline(data) {
                $('#onlines').empty()
                $('.count').text("online : " + data.length)
                data.forEach(element => {
                    $('#onlines').append(element.username + "<br>")
                });

            }

        });
    </script>
</body>

</html>